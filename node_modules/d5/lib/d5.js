var fs = require('fs'),
    path = require('path'),
    mkdirp = require('mkdirp');

function getHomeDirectory() {
    var isWindows = process.platform === 'win32';
    return isWindows ? process.env.USERPROFILE : process.env.HOME;
}

function getSettings() {
    var settings = null;

    var targetDir = path.join(getHomeDirectory(), '.d5');
    mkdirp.sync(targetDir);
    var targetFilePath = path.join(targetDir, 'defaults.json');

    try {     
        settings = require(targetFilePath);
    } catch(e) { 
        settings = require('./defaults.json');

        var contents = JSON.stringify(settings);
        fs.writeFileSync(targetFilePath, contents, 'utf8');
    }

    settings.save = function() {
        var contents = JSON.stringify(settings);
        fs.writeFileSync(targetFilePath, contents, 'utf8');
    };

    return settings;
}

function loadModule(name) {
    try {
        return require('./command/' + name);
    } catch(e) {
        return null;
    }   
}

exports = module.exports = function(commandArgs) {
    if(commandArgs.length == 0) {
        console.error('Usage: d5 {command} [command-args ...]');
        process.exit(1);
    }

    var commandName = commandArgs[0];
    if(commandName === 'help') {
        if(commandArgs.length > 1) {
            var module = loadModule(commandArgs[1]);
            if(module) {
                if(module.help) {
                    module.help();
                } else {
                    console.error('Error: "help" not available for command "' + commandArgs[1] + '"');
                    process.exit(1);
                }
            } else {
                console.error('Error: unknown command "' + commandArgs[1] + '"');
                process.exit(1);
            }
        } else {
            console.log('Usage: d5 {command} [command-args ...]');
        }
    } else {
        var module = loadModule(commandArgs[0]);
        if(module) {
            global.settings = getSettings();
            module(commandArgs.slice(1));
        } else {
            console.error('Error: unknown command "' + commandArgs[0] + '"');
            process.exit(1);
        }
    }
};